# åŸºäº Raspberry Pi 5 çš„ MQTT å‘å¸ƒ/è®¢é˜… ç®€æ˜“ ROS æ¡†æ¶

> åœ¨æ ‘è“æ´¾ PiÂ 5 ä¸Šæ„å»ºè½»é‡çº§çš„ MQTT å‘å¸ƒ/è®¢é˜…æ¶æ„ï¼Œé€šè¿‡æ¨¡å—åŒ–ã€ç³»ç»ŸæœåŠ¡åŒ–ã€è§£è€¦è®¾è®¡ï¼Œå®ç°ä¼ æ„Ÿå™¨é‡‡é›†ä¸æ‰§è¡Œå™¨æ§åˆ¶ã€‚

---

## âœ¨ æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **ç³»ç»ŸæœåŠ¡åŒ–**ï¼šå°†å„ä¸ªèŠ‚ç‚¹ï¼ˆå‘å¸ƒç«¯ã€è®¢é˜…ç«¯ã€é€»è¾‘å¤„ç†ï¼‰æ‰“åŒ…ä¸º systemd æœåŠ¡ï¼Œå¼€æœºè‡ªå¯ã€æ˜“äºç›‘æ§ä¸ç®¡ç†ã€‚
2. **æ¨¡å—åŒ–è§£è€¦**ï¼šç¡¬ä»¶é©±åŠ¨ã€MQTT é€šä¿¡ã€ä¸šåŠ¡é€»è¾‘ä¸¥æ ¼åˆ†ç¦»ï¼Œé€šè¿‡ç»Ÿä¸€çš„ä¸»é¢˜å±‚å‘å¸ƒä¸è®¢é˜…ï¼Œæ”¯æŒå¤šèŠ‚ç‚¹å¹¶è¡Œæ‰©å±•ã€‚
3. **è½»é‡åè®®**ï¼šé‡‡ç”¨ MQTT æ›¿ä»£é‡å‹ ROSï¼Œç”¨æœ€å°ä¾èµ–å®ç°å¼‚æ­¥åˆ†å¸ƒå¼é€šä¿¡ã€‚
4. **å¯æ‰©å±•æ¥å£**ï¼šé¢„ç•™æ’ä»¶æ¥å£ï¼Œå¯æ’æ‹”ä¸åŒä¼ æ„Ÿå™¨ã€æ‰§è¡Œå™¨æˆ–ç®—æ³•é€»è¾‘ã€‚

---

## ğŸ“¦ ç¯å¢ƒä¸ä¾èµ–æ¦‚è§ˆ

- **ç¡¬ä»¶**ï¼šRaspberryÂ PiÂ 5ï¼›DHTxx æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ï¼›èœ‚é¸£å™¨ç­‰ï¼ˆè¯¦ç»†æ¥çº¿è¯·å‚è€ƒå­é¡¹ç›®æ–‡æ¡£ï¼‰ã€‚
- **Broker**ï¼šMosquitto æˆ–ä»»ä½•å…¼å®¹ MQTT çš„æœåŠ¡ç«¯ã€‚
- **è¯­è¨€ä¸åº“**ï¼šPythonÂ 3.7+ï¼›`paho-mqtt`ï¼›å„ç±»ä¼ æ„Ÿå™¨é©±åŠ¨ï¼ˆå¦‚ `adafruit-circuitpython-dht`ï¼‰ã€‚
- **ç³»ç»ŸæœåŠ¡**ï¼šsystemdï¼Œç”¨äºç®¡ç†èŠ‚ç‚¹è¿›ç¨‹ã€‚

---

## ğŸ”§ å¿«é€Ÿéƒ¨ç½²ä¸æœåŠ¡ç®¡ç†

1. **è¿è¡Œå®‰è£…è„šæœ¬**ï¼ˆè‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€ç”Ÿæˆå¹¶å®‰è£… systemd æœåŠ¡ï¼‰ï¼š
   ```bash
   chmod +x install.sh
   sudo ./install.sh
   ```

2. **è°ƒè¯•ä¸ç®¡ç† systemd æœåŠ¡**

   - **æŸ¥çœ‹æœåŠ¡çŠ¶æ€**
     ```bash
     sudo systemctl status temperature_humidity-publisher.service
     ```
   - **å¯åŠ¨æœåŠ¡**
     ```bash
     sudo systemctl start temperature_humidity-publisher.service
     ```
   - **é‡å¯æœåŠ¡**
     ```bash
     sudo systemctl restart temperature_humidity-publisher.service
     ```
   - **åœæ­¢æœåŠ¡**
     ```bash
     sudo systemctl stop temperature_humidity-publisher.service
     ```
   - **å®æ—¶æŸ¥çœ‹æœåŠ¡æ—¥å¿—**
     ```bash
     sudo journalctl -u temperature_humidity-publisher.service -f
     ```
   - **ä¿®æ”¹æœåŠ¡æ–‡ä»¶åéœ€é‡è½½é…ç½®**
     ```bash
     sudo systemctl daemon-reload
     sudo systemctl restart temperature_humidity-publisher.service
     ```

   - **å¸¸è§é—®é¢˜æ’æŸ¥**
     - æœåŠ¡æ— æ³•å¯åŠ¨ï¼Œstatus=203/EXECï¼šæ£€æŸ¥æœåŠ¡æ–‡ä»¶ä¸­çš„ ExecStart å’Œ WorkingDirectory æ˜¯å¦ä¸ºç»å¯¹è·¯å¾„ï¼Œä¸”æ–‡ä»¶å­˜åœ¨ã€‚
     - æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ venv/bin/python æ˜¯å¦å­˜åœ¨ã€‚
     - æ£€æŸ¥æœåŠ¡æ–‡ä»¶å±ä¸»å’Œæƒé™ã€‚
     - æœåŠ¡å¯åŠ¨åæ— æ•°æ®å‘å¸ƒï¼šæŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤ä¼ æ„Ÿå™¨å’ŒMQTTè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚æ‰‹åŠ¨æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶è¿è¡Œä¸»ç¨‹åºï¼Œæ’æŸ¥ä¾èµ–é—®é¢˜ã€‚

3. **æ‰‹åŠ¨è°ƒè¯•ä¸æµ‹è¯•**

   è‹¥ä»…éœ€åœ¨å‘½ä»¤è¡Œä¸‹éªŒè¯å‘å¸ƒå’Œè®¢é˜…ï¼Œå¯æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
   
   ```bash
   mosquitto_sub -t sensor/temperature_humidity -v
   ```
   
   ```bash
   mosquitto_pub -t actuator/test -m '{"cmd": "ON", "id": "node1"}'
   ```

---

## ğŸ“¡ ä¸»é¢˜å±‚ä¸æ¶ˆæ¯æ ¼å¼è§„èŒƒ

| é¢†åŸŸ    | ä¸»é¢˜å‰ç¼€              | æ ¼å¼ç¤ºä¾‹                                 |
| ----- | ----------------- | ------------------------------------ |
| ä¼ æ„Ÿå™¨æ•°æ® | `sensor/{type}`   | `{"value": 23.5, "ts": 162}`         |
| æ‰§è¡Œå™¨å‘½ä»¤ | `actuator/{name}` | `{"cmd": "ON"/"OFF", "id": "node1"}` |
| çŠ¶æ€å¿ƒè·³  | `health/{node}`   | `{"status": "OK", "load": 0.1}`      |

- **æ—¶é—´æˆ³**ï¼šæ‰€æœ‰æ¶ˆæ¯å»ºè®®æºå¸¦å•ä½ç§’çš„ UTC æ—¶é—´æˆ³ã€‚
- **èŠ‚ç‚¹ ID**ï¼šåŒºåˆ†ä¸åŒå®ä¾‹ï¼Œä¾¿äºæ—¥å¿—å’Œæ•…éšœæ’æŸ¥ã€‚

---

## ğŸš€ ç¤ºä¾‹è„šæœ¬æ¦‚è§ˆ

### sensors/temperature_humidity/temperature_humidity_pub.py

```python
# è´Ÿè´£è¯»å– DHT22 æ¸©æ¹¿åº¦å¹¶å‘å¸ƒåˆ° MQTT
# å¼•å…¥é…ç½®ä¸å…¬ç”¨æ¨¡å—ï¼Œå®ç°å¯æ’æ‹”
# æ”¯æŒè‡ªåŠ¨é‡è¿ã€å¥åº·çŠ¶æ€ç›‘æ§ã€æ•°æ®éªŒè¯
```

### actuators/buzzer/buzzer_sub.py

```python
# è®¢é˜… actuator/buzzer ä¸»é¢˜ï¼Œæ ¹æ®æŒ‡ä»¤æ§åˆ¶èœ‚é¸£å™¨é¸£å«
```

---


