# åŸºäº Raspberry Pi 5 çš„ MQTT å‘å¸ƒ/è®¢é˜… ç®€æ˜“ ROS æ¡†æ¶

> åœ¨æ ‘è“æ´¾ Pi 5 ä¸Šæ„å»ºè½»é‡çº§çš„ MQTT å‘å¸ƒ/è®¢é˜…æ¶æ„ï¼Œé€šè¿‡æ¨¡å—åŒ–ã€ç³»ç»ŸæœåŠ¡åŒ–ã€è§£è€¦è®¾è®¡ï¼Œå®ç°ä¼ æ„Ÿå™¨é‡‡é›†ä¸æ‰§è¡Œå™¨æ§åˆ¶ã€‚

---

## âœ¨ æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **ç³»ç»ŸæœåŠ¡åŒ–**ï¼šå°†å„ä¸ªèŠ‚ç‚¹ï¼ˆå‘å¸ƒç«¯ã€è®¢é˜…ç«¯ã€é€»è¾‘å¤„ç†ï¼‰æ‰“åŒ…ä¸º systemd æœåŠ¡ï¼Œå¼€æœºè‡ªå¯ã€æ˜“äºç›‘æ§ä¸ç®¡ç†ã€‚
2. **æ¨¡å—åŒ–è§£è€¦**ï¼šç¡¬ä»¶é©±åŠ¨ã€MQTT é€šä¿¡ã€ä¸šåŠ¡é€»è¾‘ä¸¥æ ¼åˆ†ç¦»ï¼Œé€šè¿‡ç»Ÿä¸€çš„ä¸»é¢˜å±‚å‘å¸ƒä¸è®¢é˜…ï¼Œæ”¯æŒå¤šèŠ‚ç‚¹å¹¶è¡Œæ‰©å±•ã€‚
3. **è½»é‡åè®®**ï¼šé‡‡ç”¨ MQTT æ›¿ä»£é‡å‹ ROSï¼Œç”¨æœ€å°ä¾èµ–å®ç°å¼‚æ­¥åˆ†å¸ƒå¼é€šä¿¡ã€‚
4. **å¯æ‰©å±•æ¥å£**ï¼šé¢„ç•™æ’ä»¶æ¥å£ï¼Œå¯æ’æ‹”ä¸åŒä¼ æ„Ÿå™¨ã€æ‰§è¡Œå™¨æˆ–ç®—æ³•é€»è¾‘ã€‚
5. **ç»Ÿä¸€ä¼ æ„Ÿå™¨æ¶æ„**ï¼šæ‰€æœ‰ä¼ æ„Ÿå™¨ä½¿ç”¨æ ‡å‡†åŒ–çš„æ•°æ®æ ¼å¼ï¼Œé€šè¿‡ç‹¬ç«‹çš„ä¼ æ„Ÿå™¨ç®¡ç†æœåŠ¡å®ç°å¯é…ç½®çš„ä¸šåŠ¡é€»è¾‘ç»‘å®šã€‚

---

## ğŸ“¦ ç¯å¢ƒä¸ä¾èµ–æ¦‚è§ˆ

- **ç¡¬ä»¶**ï¼šRaspberry Pi 5ï¼›DHTxx æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ï¼›PIRçº¢å¤–ä¼ æ„Ÿå™¨ï¼ˆHC-SR501ï¼‰ï¼›èœ‚é¸£å™¨ç­‰ï¼ˆè¯¦ç»†æ¥çº¿è¯·å‚è€ƒå­é¡¹ç›®æ–‡æ¡£ï¼‰ã€‚
- **Broker**ï¼šMosquitto æˆ–ä»»ä½•å…¼å®¹ MQTT çš„æœåŠ¡ç«¯ã€‚
- **è¯­è¨€ä¸åº“**ï¼šPython 3.7+ï¼›`paho-mqtt`ï¼›å„ç±»ä¼ æ„Ÿå™¨é©±åŠ¨ï¼ˆå¦‚ `adafruit-circuitpython-dht`ã€`gpiozero`ï¼‰ã€‚
- **ç³»ç»ŸæœåŠ¡**ï¼šsystemdï¼Œç”¨äºç®¡ç†èŠ‚ç‚¹è¿›ç¨‹ã€‚

---

## ğŸ”§ å¿«é€Ÿéƒ¨ç½²ä¸æœåŠ¡ç®¡ç†

### ä¼ ç»Ÿæ–¹å¼ï¼ˆç³»ç»ŸæœåŠ¡ï¼‰

1. **è¿è¡Œå®‰è£…è„šæœ¬**ï¼ˆè‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€ç”Ÿæˆå¹¶å®‰è£… systemd æœåŠ¡ï¼‰ï¼š
   ```bash
   chmod +x install.sh
   sudo ./install.sh
   ```

2. **è°ƒè¯•ä¸ç®¡ç† systemd æœåŠ¡**

   - **æŸ¥çœ‹æœåŠ¡çŠ¶æ€**
     ```bash
     sudo systemctl status temperature_humidity-publisher.service
     ```
   - **å¯åŠ¨æœåŠ¡**
     ```bash
     sudo systemctl start temperature_humidity-publisher.service
     ```
   - **é‡å¯æœåŠ¡**
     ```bash
     sudo systemctl restart temperature_humidity-publisher.service
     ```
   - **åœæ­¢æœåŠ¡**
     ```bash
     sudo systemctl stop temperature_humidity-publisher.service
     ```
   - **å®æ—¶æŸ¥çœ‹æœåŠ¡æ—¥å¿—**
     ```bash
     sudo journalctl -u temperature_humidity-publisher.service -f
     ```
   - **ä¿®æ”¹æœåŠ¡æ–‡ä»¶åéœ€é‡è½½é…ç½®**
     ```bash
     sudo systemctl daemon-reload
     sudo systemctl restart temperature_humidity-publisher.service
     ```

   - **å¸¸è§é—®é¢˜æ’æŸ¥**
     - æœåŠ¡æ— æ³•å¯åŠ¨ï¼Œstatus=203/EXECï¼šæ£€æŸ¥æœåŠ¡æ–‡ä»¶ä¸­çš„ ExecStart å’Œ WorkingDirectory æ˜¯å¦ä¸ºç»å¯¹è·¯å¾„ï¼Œä¸”æ–‡ä»¶å­˜åœ¨ã€‚
     - æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ venv/bin/python æ˜¯å¦å­˜åœ¨ã€‚
     - æ£€æŸ¥æœåŠ¡æ–‡ä»¶å±ä¸»å’Œæƒé™ã€‚
     - æœåŠ¡å¯åŠ¨åæ— æ•°æ®å‘å¸ƒï¼šæŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤ä¼ æ„Ÿå™¨å’ŒMQTTè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚æ‰‹åŠ¨æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶è¿è¡Œä¸»ç¨‹åºï¼Œæ’æŸ¥ä¾èµ–é—®é¢˜ã€‚

3. **æ‰‹åŠ¨è°ƒè¯•ä¸æµ‹è¯•**

   è‹¥ä»…éœ€åœ¨å‘½ä»¤è¡Œä¸‹éªŒè¯å‘å¸ƒå’Œè®¢é˜…ï¼Œå¯æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
   
   ```bash
   mosquitto_sub -t sensor/temperature_humidity -v
   mosquitto_sub -t sensor/pir_motion -v
   ```
   
   ```bash
   mosquitto_pub -t actuator/test -m '{"cmd": "ON", "id": "node1"}'
   ```

---

## ğŸ“¡ ä¸»é¢˜å±‚ä¸æ¶ˆæ¯æ ¼å¼è§„èŒƒ


æ‰€æœ‰ä¼ æ„Ÿå™¨ç°åœ¨éƒ½ä½¿ç”¨æ ‡å‡†åŒ–çš„JSONæ ¼å¼ï¼Œå‘å¸ƒåˆ° `sensor/sensor` topicï¼š

```json
{
    "type": "sensor_type",
    "params": {
        // ä¼ æ„Ÿå™¨ç‰¹å®šå‚æ•°
    },
    "timestamp": 1234567890
}
```

### å„ä¼ æ„Ÿå™¨æ•°æ®æ ¼å¼ç¤ºä¾‹

#### Button ä¼ æ„Ÿå™¨
```json
{
    "type": "button",
    "params": {
        "action": "pressed",
        "timestamp": 1754104570
    },
    "timestamp": 1754104570
}
```

#### Volume Knob ä¼ æ„Ÿå™¨
```json
{
    "type": "volume_knob",
    "params": {
        "volume": 75,
        "timestamp": 1754104570
    },
    "timestamp": 1754104570
}
```

#### PIR Motion ä¼ æ„Ÿå™¨
```json
{
    "type": "pir_motion",
    "params": {
        "motion": "detected",
        "timestamp": 1754104570
    },
    "timestamp": 1754104570
}
```

#### Temperature Humidity ä¼ æ„Ÿå™¨
```json
{
    "type": "temperature_humidity",
    "params": {
        "temperature": 25.5,
        "humidity": 60.2,
        "timestamp": 1754104570
    },
    "timestamp": 1754104570
}
```

### æ§åˆ¶æ¶ˆæ¯æ ¼å¼

ä¼ æ„Ÿå™¨ç®¡ç†æœåŠ¡å‘å¸ƒåˆ°å¯¹åº”çš„æ§åˆ¶topicï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```json
{
    "action": "action_name",
    "params": {
        // åŸå§‹ä¼ æ„Ÿå™¨å‚æ•°
    },
    "source": "sensor_type",
    "timestamp": 1234567890
}
```

### ä¼ ç»Ÿæ ¼å¼ï¼ˆå…¼å®¹ï¼‰

| é¢†åŸŸ    | ä¸»é¢˜å‰ç¼€              | æ ¼å¼ç¤ºä¾‹                                 |
| ----- | ----------------- | ------------------------------------ |
| ä¼ æ„Ÿå™¨æ•°æ® | `sensor/{type}`   | `{"temperature": 23.5, "humidity": 40.2, "timestamp": 162}` / `{"motion_detected": true, "timestamp": 162}` |
| é€šç”¨æ§åˆ¶æŒ‡ä»¤ | `sensor/common`   | `{"action": "button_pressed", "params": {"timestamp": 162}}` |
| æ‰§è¡Œå™¨å‘½ä»¤ | `actuator/{name}` | `{"action": true, "params": {"times": 3}}` |

- **æ—¶é—´æˆ³**ï¼šæ‰€æœ‰æ¶ˆæ¯å»ºè®®æºå¸¦å•ä½ç§’çš„ UTC æ—¶é—´æˆ³ã€‚

---

## ğŸ“‹ å·²å®ç°çš„ä¼ æ„Ÿå™¨ä¸æ‰§è¡Œå™¨

### ä¼ æ„Ÿå™¨ï¼ˆPublishersï¼‰
- `temperature_humidity` - DHT22 æ¸©æ¹¿åº¦
- `button` - GPIO æŒ‰é”®
- `pir` - PIR çº¢å¤–è¿åŠ¨
- `volume_knob` - éŸ³é‡æ—‹é’®ï¼ˆADS1115ï¼‰

### æ‰§è¡Œå™¨ï¼ˆSubscribersï¼‰
- `buzzer` - èœ‚é¸£å™¨
- `oled` - OLED æ˜¾ç¤ºå±



#### ä¼˜åŠ¿
- âœ… ä¼ æ„Ÿå™¨åªå‘å¸ƒåŸå§‹æ•°æ®ï¼ŒèŒè´£å•ä¸€
- âœ… ç»Ÿä¸€çš„æ•°æ®æ ¼å¼ï¼Œä¾¿äºå¤„ç†
- âœ… å¯é…ç½®çš„ä¸šåŠ¡é€»è¾‘ç»‘å®š
- âœ… ç‹¬ç«‹çš„ä¼ æ„Ÿå™¨ç®¡ç†æœåŠ¡
- âœ… æ˜“äºæ‰©å±•å’Œç»´æŠ¤


```
ä¼ æ„Ÿå™¨ â†’ å‘å¸ƒåŸå§‹æ•°æ® â†’ ç®¡ç†æœåŠ¡ â†’ ä¸šåŠ¡é€»è¾‘ç»‘å®š â†’ æ‰§è¡Œå™¨
```

### æ•°æ®æµå‘
1. **ä¼ æ„Ÿå™¨å±‚**: å‘å¸ƒåˆ° `sensor/sensor` topic
2. **ç®¡ç†æœåŠ¡å±‚**: è®¢é˜…å¹¶å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®
3. **ä¸šåŠ¡é€»è¾‘å±‚**: æ ¹æ®é…ç½®æ‰§è¡Œç»‘å®šåŠ¨ä½œ
4. **æ‰§è¡Œå™¨å±‚**: æ¥æ”¶æ§åˆ¶æŒ‡ä»¤å¹¶æ‰§è¡Œ

---

## ğŸš€ ç¤ºä¾‹è„šæœ¬æ¦‚è§ˆ

### sensors/temperature_humidity/temperature_humidity_pub.py

```python
# è´Ÿè´£è¯»å– DHT22 æ¸©æ¹¿åº¦å¹¶å‘å¸ƒåˆ° MQTT
# å¼•å…¥é…ç½®ä¸å…¬ç”¨æ¨¡å—ï¼Œå®ç°å¯æ’æ‹”
```
- **æ¶ˆæ¯æ ¼å¼**ï¼š

  ```json
  {
    "temperature": 25.1,
    "humidity": 40.2,
    "timestamp": 1710000000
  }
  ```


### sensors/button/button_pub.py

```python
# è´Ÿè´£æ£€æµ‹ç‰©ç†æŒ‰é”®äº‹ä»¶å¹¶å‘å¸ƒåˆ° MQTT
# ä»…åœ¨æŒ‰é”®è¢«æŒ‰ä¸‹æ—¶å‘å¸ƒäº‹ä»¶å‹æ¶ˆæ¯ï¼Œç»“æ„ä¸æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ä¸€è‡´
```

- **æ¶ˆæ¯æ ¼å¼**ï¼š

  ```json
  {
    "action": "button_pressed",
    "params": {
      "timestamp": 1710000000
    }
  }
  ```

### sensors/pir/pir_pub.py

```python
# åŸºäº gpiozero.MotionSensor çš„ PIR çº¢å¤–ä¼ æ„Ÿå™¨
# æ£€æµ‹è¿åŠ¨çŠ¶æ€å˜åŒ–å¹¶å‘å¸ƒåˆ° MQTTï¼Œæ”¯æŒè¿åŠ¨æ£€æµ‹å’Œæ— è¿åŠ¨çŠ¶æ€
# å‚è€ƒç”¨æˆ·ç¤ºä¾‹ä»£ç å®ç°ï¼Œç®€æ´é«˜æ•ˆ
```

- **æ¶ˆæ¯æ ¼å¼**ï¼š

  ```json
  {
    "motion_detected": true,
    "timestamp": 1710000000
  }
  ```


`motion_detected` ä¸º `true` æ—¶è¡¨ç¤ºæ£€æµ‹åˆ°è¿åŠ¨ï¼Œä¸º `false` æ—¶è¡¨ç¤ºæ— è¿åŠ¨çŠ¶æ€ã€‚

### sensors/volume_knob/volume_knob_pub.py

```python
# åŸºäº ADS1115 çš„æ—‹è½¬ç”µä½å™¨ä¼ æ„Ÿå™¨ï¼Œå‘å¸ƒéŸ³é‡ç™¾åˆ†æ¯”
# éœ€è¦å…ˆæ‰§è¡Œ calibrate.sh å®Œæˆæ ¡å‡†
```

- **æ¶ˆæ¯æ ¼å¼**ï¼š

  ```json
  {
    "action": "set_volume",
    "params": {
      "volume": 75
    }
  }
  ```

### actuators/buzzer/buzzer_sub.py

```python
# è®¢é˜… actuator/buzzer ä¸»é¢˜ï¼Œæ ¹æ®æŒ‡ä»¤æ§åˆ¶èœ‚é¸£å™¨é¸£å«
```

- **æ¶ˆæ¯æ ¼å¼**ï¼š

  ```json
  {
    "action": true,
    "params": {"times": 3, "interval": 0.2}
  }
  ```

  `action` è®¾ä¸º `true` æ—¶æŒ‰å‚æ•°é¸£å«ï¼Œè®¾ä¸º `false` åˆ™åœæ­¢å½“å‰èœ‚é¸£ã€‚


---

## ğŸ—ï¸ ç»Ÿä¸€æ ¡å‡†æ¶æ„

é¡¹ç›®æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ä¼ æ„Ÿå™¨æ ¡å‡†æœºåˆ¶ï¼šä»»ä½•éœ€è¦æ ¡å‡†çš„æ¨¡å—éƒ½åŒ…å«åä¸º
`calibrate.sh` çš„è„šæœ¬ï¼Œ`install.sh` ä¼šåœ¨å®‰è£…è¿‡ç¨‹ä¸­æ£€æµ‹æ ¡å‡†çŠ¶æ€å¹¶ç»™å‡ºæç¤ºã€‚

æ ¡å‡†æµç¨‹å’Œç¤ºä¾‹å¯åœ¨éŸ³é‡æ—‹é’®æ¨¡å—çš„æ–‡æ¡£ä¸­æŸ¥çœ‹ï¼Œè·¯å¾„ä¸º
[`sensors/volume_knob/README.md`](sensors/volume_knob/README.md)ã€‚è¯¥æ–‡æ¡£è¯¦ç»†
ä»‹ç»äº†å¦‚ä½•è¿è¡Œæ ¡å‡†è„šæœ¬ä»¥åŠæ ¡å‡†ç»“æœå¦‚ä½•è¢«æœåŠ¡åŠ è½½ã€‚å…¶ä»–ä¼ æ„Ÿå™¨å¯ä»¥æŒ‰ç…§åŒ
æ ·çš„æµç¨‹æ‰©å±•æ ¡å‡†æ”¯æŒã€‚

### æ ¡å‡†ç»“æœæŒä¹…åŒ–
- âœ… æ ¡å‡†åè‡ªåŠ¨ä¿å­˜åˆ° `config.ini`
- âœ… é‡å¯ç¨‹åºè‡ªåŠ¨åŠ è½½æ ¡å‡†å‚æ•°
- âœ… æ— éœ€é‡å¤æ ¡å‡†

---
